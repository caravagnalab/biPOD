---
title: "3. LogisticGrowth"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(biPOD)
T <- 3
time_steps <- 12
delta_t <- T / time_steps
d <- biPOD::sim_stochastic_logistic(n0 = 1000, lambda = 1.5, mu = .2, K = 2000, delta_t = delta_t, steps = time_steps)
```

The `fit_log` function can be used to fit a model over an input dataframe assuming an exponential growth.
The function requires as input a `biPOD` object along with two main additional parameters:

- `model_type` : the type of model to use among `gauss`
- `prior`      : the type of prior to use among `uniform` and `invgamma`

Additionally, one can tune many additional parameters for specific purposes:

- `prior_K`, `a`, `b`, `g` : parameters to tune the shape of the prior distribution
- `chains`, `iter`, `warmup`, `cores` : parameters for the MCMC algorithm

A fit with fixed rates can be obtained without adding any `group` column to the input dataframe.

```{r fit log fixed, results=FALSE, message=FALSE}
bipod <- biPOD::init(d, "logistic sample using MCMC")
biPOD::evolution_plot(bipod)
bipod <- biPOD::fit_log(bipod, model_type = "gauss", prior = "invgamma", a = 1, b = 1)
```

The bipod object does now contains a field names `fits` which contains every fit for every group, in this case only one. 
The results of the fit can be visually inspected using:

- `plot_traces` : plot the traces of the MCMC chains, passing as `pars` a vector of desired parameter and the `diagnose` flag 
- `plot_birth_and_death_rates_posteriors` : to plot the prior and posteriors for the birth and death parameters
- `plot_growth_rate_posteriors` : to plot the prior and posteriors for the growth rates
- `plot_fit` : to plot the fitted curve against the observed data

```{r, results=FALSE, message=FALSE}
biPOD::plot_traces(bipod, pars = c("lambda", "mu"), diagnose = TRUE)
biPOD::plot_birth_and_death_rates_posteriors(bipod)
biPOD::plot_growth_rate_posteriors(bipod)
biPOD::plot_fit(bipod)
```

The fit can also obtained using variational inference. In order to do so, it is necessary to pass the flag `variational = TRUE` to the `fit_log` function.

```{r fit log fixed, results=FALSE, message=FALSE}
bipod_vb <- biPOD::init(d, "logistic sample using VB")
bipod_vb <- biPOD::fit_log(bipod_vb, model_type = "gauss", prior = "invgamma", a = 2, b = 2, variational = TRUE)
```

The bipod object does now contain a field named `elbo_data` which contains information regarding the ELBO for every group.
The results of the fit can be visually inspected using:

- `plot_elbo` : plot the diagnostic of the ELBO, passing the `diagnose` flag 
- `plot_birth_and_death_rates_posteriors` : to plot the prior and posteriors for the birth and death parameters
- `plot_growth_rate_posteriors` : to plot the prior and posteriors for the growth rates
- `plot_fit` : to plot the fitted curve against the observed data

```{r, results=FALSE, message=FALSE}
biPOD::plot_elbo(bipod_vb, diagnose = TRUE)
biPOD::plot_birth_and_death_rates_posteriors(bipod_vb)
biPOD::plot_growth_rate_posteriors(bipod_vb)
biPOD::plot_fit(bipod_vb)
```
