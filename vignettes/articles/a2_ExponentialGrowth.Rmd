---
title: "2. Exponential Growth"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(biPOD)
T <- 3
time_steps <- 12
delta_t <- T / time_steps
d <- biPOD::sim_stochastic_exponential(10000, 1, .5, steps = time_steps, delta_t = delta_t)
```

The `fit` function along with the parameter `growth_type = "exponential"` can be used to fit a model over an input dataframe assuming an exponential growth.
The function requires as input a `biPOD` object. Other important parameters are:

- `factor_size` : value by which every input will be divided. Default is set to `1`
- `t0_lower_bound` : lowest value allowed for `t0`, which denotes the time point in which the population size was equal to `factor_size`

Additionally, one can tune many additional parameters for specific purposes:

- `chains`, `iter`, `warmup`, `cores` : parameters for the MCMC algorithm

A fit with fixed rates can be obtained without adding any `group` column to the input dataframe.

```{r fit exp fixed}
x <- biPOD::init(d, "exponential sample")
x <- biPOD::fit(x, growth_type = "exponential", factor_size = 1)
```

The warning message says that many transitions were divergent. The very first two parameters that can be tweaked in this case are the `factor_size` and the `t0_lower_bound`. One can examine the posterior of `t0` in order to understand if that's the problem.

```{r}
biPOD::plot_t0_posterior(x)
```

We can clearly see that the posterior is extremely skewed towards the lowest value allowed for `t0`. Hence, it might be a good idea to re-fit with a lower value.

```{r}
x <- biPOD::fit(x, growth_type = "exponential", factor_size = 1, t0_lower_bound = -100)
```
Now the fitting went smoothly. The bipod object does now contains a field named `fit` which contains the information about the fitted model. 
The results of the fit can be visually inspected using:

- `plot_traces` : plot the traces of the MCMC chains, passing as `pars` a vector of desired parameter. You set `diagnose` to `TRUE` to obtain a visual representation about the goodness of the chains.
- `plot_normalized_growth_rate_posteriors` : to plot the normalized posteriors for the growth rates
- `plot_fit` : to plot the fitted curve against the observed data

```{r}
biPOD::plot_traces(x, pars = c("rho[1]"), diagnose = T)
biPOD::plot_normalized_growth_rate_posteriors(x)
biPOD::plot_fit(x)
```

To obtain a fit with variable growth rates one should gives the breakpoints as input. We will use three group:

```{r fit exp variable}
break_points <- c(.8, 1.7)
gx <- biPOD::init(d, "Grouped sample", break_points = break_points)
gx <- biPOD::fit(gx, growth_type = "exponential", t0_lower_bound = -100, factor_size = 1)
```
You might obtain warnings regarding transitions that exceeded the maximum treedepth, but they do not represent an error during the fitting. 
Obviously, the results can be once again visually inspected:

```{r}
biPOD::plot_traces(gx, pars = c("rho[1]", "rho[2]", "rho[3]"), diagnose = T)
biPOD::plot_normalized_growth_rate_posteriors(gx)
biPOD::plot_fit(gx)
```
